<%# Accepts: participant (required), check (required), line_items (optional), show_zero_items (optional, defaults to true) %>
<% line_items ||= check.line_items.includes(:participants, :addons).order(:position, :created_at) %>
<% show_zero_items = true unless local_assigns.key?(:show_zero_items) %>

<% participant_items = line_items.select { |item| item.participant_ids.include?(participant.id) } %>
<% display_items = show_zero_items ? participant_items : participant_items.reject { |item| item.total_with_addons == 0 } %>
<% items_subtotal = participant_items.sum { |item| item.amount_per_participant } %>
<% proportion = check.subtotal > 0 ? items_subtotal / check.subtotal : 0 %>
<% treated_coverage_amount = check.treated_coverage_amount_for(participant) %>
<% treated_participants = check.treated_participants %>
<% non_treated_count = check.participants.count - treated_participants.count %>
<% treating_lines = if participant.is_being_treated? || non_treated_count <= 0
  []
else
  treated_participants.filter_map do |treated_participant|
    treated_participant_coverage_amount = check.treated_coverage_amount_for(treated_participant)
    next if treated_participant_coverage_amount <= 0

    [treated_participant, treated_participant_coverage_amount / non_treated_count]
  end
end %>
<div id="<%= dom_id(participant, :breakdown) %>" class="list-group-item py-3 px-3 d-flex flex-column gap-3" data-turbo-refresh-animate>
  <div class="d-flex justify-content-between align-items-center">
    <strong>
      <%= participant.name %>
      <% if participant.is_being_treated? %>
        <span class="badge text-bg-success ms-1">Being treated</span>
      <% end %>
      <% if participant_items.any? && check.subtotal > 0 %>
        <span class="fw-normal text-muted">(share: <%= number_to_percentage(proportion * 100, precision: 0) %>)</span>
      <% end %>
    </strong>
    <strong><%= format_currency(check.amount_owed_by(participant), check.currency_symbol) %></strong>
  </div>

  <% if participant_items.any? %>
    <% display_items.each do |item| %>
      <% share = item.amount_per_participant %>
      <div class="d-flex justify-content-between text-muted">
        <span>
          <%= item.description %>
          <% other_participants = item.participants.reject { |p| p.id == participant.id } %>
          <% if other_participants.any? %>
            <% shared_text = item.participants.size == check.participants.size ? "all" : other_participants.map(&:name).to_sentence %>
            <span class="text-muted">(shared with <%= shared_text %>)</span>
          <% end %>
        </span>
        <span><%= format_currency(share, check.currency_symbol) %></span>
      </div>
    <% end %>

    <% if check.subtotal > 0 && check.total_discounts > 0 %>
      <% discounts_share = check.total_discounts * proportion %>
      <div class="d-flex justify-content-between text-success">
        <span>Share of discounts</span>
        <span>-<%= format_currency(discounts_share, check.currency_symbol) %></span>
      </div>
    <% end %>

    <% if check.subtotal > 0 && check.total_fees > 0 %>
      <% fees_share = check.total_fees * proportion %>
      <div class="d-flex justify-content-between text-muted">
        <span>Share of tax, tip, and other fees</span>
        <span><%= format_currency(fees_share, check.currency_symbol) %></span>
      </div>
    <% end %>
  <% else %>
    <div class="text-muted fst-italic">No items assigned</div>
  <% end %>

  <% if participant.is_being_treated? && treated_coverage_amount > 0 %>
    <div class="d-flex justify-content-between text-success">
      <span>Being treated</span>
      <span>-<%= format_currency(treated_coverage_amount, check.currency_symbol) %></span>
    </div>
  <% else %>
    <% treating_lines.each do |treated_participant, amount| %>
      <div class="d-flex justify-content-between text-muted">
        <span>Treating <%= treated_participant.name %></span>
        <span><%= format_currency(amount, check.currency_symbol) %></span>
      </div>
    <% end %>
  <% end %>
</div>
