<%= turbo_stream_from @check %>

<div class="py-3">
  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="text-center mb-3">
    <div class="mx-auto" style="max-width: 300px;">
      <%= qr_code_svg(check_url(@check), level: :m) %>
    </div>
    <div class="mt-2"><i class="bi bi-qr-code-scan"></i> Scan to join</div>
    <button class="btn btn-primary w-100 mt-2"
            data-controller="clipboard"
            data-clipboard-text-value="<%= check_url(@check) %>"
            data-action="clipboard#copy">
      <i class="bi bi-clipboard"></i> Copy link
    </button>
  </div>

  <% if @check.parsing? %>
    <div class="text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h2 class="h5">Parsing your receipt...</h2>
      <p class="text-muted">This usually takes a few seconds</p>
    </div>

    <% if @check.receipt_image.attached? %>
      <div class="card">
        <%= cl_image_tag @check.receipt_image.key,
            width: 800,
            quality: :auto,
            fetch_format: :auto,
            class: "card-img" %>
      </div>
    <% end %>
  <% else %>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h4 mb-1"><%= @check.restaurant_name || "Check" %></h1>
          <div class="text-muted">
            <% if @check.restaurant_address.present? %>
              <div><i class="bi bi-geo-alt"></i> <%= @check.restaurant_address %></div>
            <% end %>
            <% if @check.restaurant_phone_number.present? %>
              <div><i class="bi bi-telephone"></i> <%= @check.restaurant_phone_number %></div>
            <% end %>
            <% if @check.billed_on.present? %>
              <div><i class="bi bi-calendar"></i> <%= @check.billed_on.strftime("%b %d, %Y") %></div>
            <% end %>
          </div>
        </div>
        <%= render partial: "checks/header_stats", locals: { check: @check } %>
      </div>
    </div>
    <% if @check.receipt_image.attached? %>
      <%= cl_image_tag @check.receipt_image.key,
          width: 800,
          quality: :auto,
          fetch_format: :auto,
          class: "card-img" %>
    <% end %>
    <div class="card-footer">
      <div class="d-flex justify-content-between align-items-center">
        <%= form_with url: update_currency_check_path(@check), method: :patch, local: true do %>
          <%= select_tag :currency,
              options_for_select(currency_options_for_select, @check.currency),
              class: "form-select form-select-sm",
              style: "width: auto;",
              onchange: "this.form.submit()" %>
        <% end %>
        <div class="form-check form-switch m-0">
          <%= form_with url: toggle_zero_items_check_path(@check), method: :post, local: true do %>
            <input class="form-check-input" type="checkbox" role="switch" id="showZeroItems" <%= "checked" if @show_zero_items %> onchange="this.form.submit()">
            <label class="form-check-label" for="showZeroItems">Show <%= @check.currency_symbol %>0 items</label>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header py-3">
      <strong><%= t("participants.header") %></strong>
    </div>

    <ul class="list-group list-group-flush">
      <% @participants.each do |participant| %>
        <%= render partial: "participants/participant", locals: { participant: participant, check: @check } %>
      <% end %>
      <%= render partial: "participants/new_form", locals: { participant: Participant.new, check: @check } %>
    </ul>
  </div>

  <% if @participants.empty? %>
    <div class="alert alert-warning">
      <%= t("participants.add_prompt") %>
    </div>
  <% end %>

  <% if @line_items.empty? %>
    <div class="alert alert-warning">
      No items found on this receipt.
    </div>
  <% else %>
    <div class="card mb-3">
      <div class="card-header py-3">
        <strong>Items</strong>
      </div>

      <ul id="line_items_list" class="list-group list-group-flush">
        <% @line_items.each do |item| %>
          <% next if !@show_zero_items && item.total_with_addons == 0 %>
          <%= render partial: "line_items/line_item", locals: { line_item: item, participants: @participants, show_zero_items: @show_zero_items } %>
        <% end %>
        <%= render partial: "line_items/new_form", locals: { line_item: LineItem.new, check: @check } %>
      </ul>

      <%= render partial: "checks/item_total", locals: { check: @check } %>
    </div>

    <div class="card mb-3">
      <div class="card-header py-3">
        <strong>Discounts</strong>
      </div>

      <ul class="list-group list-group-flush">
        <% @global_discounts.each do |discount| %>
          <%= render partial: "global_discounts/global_discount", locals: { global_discount: discount, check: @check } %>
        <% end %>
        <%= render partial: "global_discounts/new_form", locals: { global_discount: GlobalDiscount.new, check: @check } %>
      </ul>

      <% if @global_discounts.any? %>
        <%= render partial: "checks/after_discounts_total", locals: { check: @check } %>
      <% end %>
    </div>

    <div class="card mb-3">
      <div class="card-header py-3">
        <strong>Tax, tip, and other fees</strong>
      </div>

      <ul class="list-group list-group-flush">
        <% @global_fees.in_order_of(:fee_type, %w[tax other tip]).order(amount: :desc).each do |fee| %>
          <% next if !@show_zero_items && fee.amount == 0 %>
          <%= render partial: "global_fees/global_fee", locals: { global_fee: fee, check: @check } %>
        <% end %>

        <%= render partial: "global_fees/tip_suggestion", locals: { check: @check } %>

        <%= render partial: "global_fees/new_form", locals: { global_fee: GlobalFee.new, check: @check } %>
      </ul>

      <%= render partial: "checks/grand_total", locals: { check: @check } %>
    </div>

    <% if @participants.any? %>
      <%= render partial: "checks/breakdown", locals: { check: @check, participants: @participants, line_items: @line_items, show_zero_items: @show_zero_items } %>
    <% end %>
  <% end %>

  <% end %>
</div>

