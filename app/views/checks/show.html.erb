<div class="container py-3">
  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if @check.receipt_image.attached? %>
    <div class="mb-3">
      <%= image_tag @check.receipt_image, class: "img-fluid rounded" %>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h5 mb-1"><%= @check.restaurant_name || "Check" %></h1>
      <div class="text-muted small">
        <% if @check.billed_on.present? %>
          <%= @check.billed_on.strftime("%b %d, %Y") %>
        <% end %>
      </div>
    </div>
    <div class="text-end">
      <div class="h4 mb-0">$<%= number_with_precision(@check.grand_total, precision: 2) %></div>
      <div class="text-muted small"><%= @participants.count %> people</div>
    </div>
  </div>

  <% if @participants.empty? %>
    <div class="alert alert-warning">
      No participants yet. <%= link_to "Add participants", new_check_participant_path(@check) %> to start splitting.
    </div>
  <% elsif @line_items.empty? %>
    <div class="alert alert-warning">
      No items found on this receipt.
    </div>
  <% else %>
    <%= form_with model: @check, local: true do |f| %>
      <div class="card mb-3">
        <div class="card-header py-2">
          <strong class="small">Items</strong>
        </div>

        <ul class="list-group list-group-flush">
          <% @line_items.each_with_index do |item, index| %>
            <%= f.fields_for :line_items_attributes, item, index: index do |item_fields| %>
              <%= item_fields.hidden_field :id %>

              <li class="list-group-item py-2 px-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="d-flex align-items-start">
                    <span class="text-muted small me-2" style="min-width: 50px;">$<%= number_with_precision(item.total_price, precision: 2) %></span>
                    <div>
                      <strong class="small"><%= item.description %></strong>
                      <% if item.quantity > 1 %>
                        <span class="text-muted small">(<%= item.quantity %>x @ $<%= number_with_precision(item.unit_price, precision: 2) %> each)</span>
                      <% end %>
                    </div>
                  </div>
                  <strong class="small">$<%= number_with_precision(item.total_with_addons, precision: 2) %></strong>
                </div>
                <% item.addons.each do |addon| %>
                  <div class="d-flex align-items-start mb-1 ps-2">
                    <span class="text-muted small me-2" style="min-width: 50px;">$<%= number_with_precision(addon.total_price, precision: 2) %></span>
                    <span class="text-muted small">+ <%= addon.description %></span>
                  </div>
                <% end %>

                <div class="d-flex flex-wrap gap-2">
                  <% @participants.each do |participant| %>
                    <div class="form-check form-check-inline m-0">
                      <%= check_box_tag "check[line_items_attributes][#{index}][participant_ids][]",
                          participant.id,
                          item.participant_ids.include?(participant.id),
                          id: "item_#{index}_participant_#{participant.id}",
                          class: "form-check-input" %>
                      <%= label_tag "item_#{index}_participant_#{participant.id}",
                          participant.name,
                          class: "form-check-label small" %>
                    </div>
                  <% end %>
                </div>
              </li>
            <% end %>
          <% end %>
        </ul>

        <div class="card-footer py-2 px-3">
          <div class="d-flex justify-content-between small">
            <strong>Item total</strong>
            <strong>$<%= number_with_precision(@check.subtotal, precision: 2) %></strong>
          </div>
        </div>
      </div>

      <% if @global_discounts.any? %>
        <div class="card mb-3">
          <div class="card-header py-2">
            <strong class="small">Discounts</strong>
          </div>

          <ul class="list-group list-group-flush">
            <% @global_discounts.each do |discount| %>
              <li class="list-group-item py-2 px-3">
                <div class="d-flex justify-content-between small text-success">
                  <span><%= discount.description %></span>
                  <span>-$<%= number_with_precision(discount.amount, precision: 2) %></span>
                </div>
              </li>
            <% end %>
          </ul>

          <div class="card-footer py-2 px-3">
            <div class="d-flex justify-content-between small">
              <strong>After discounts</strong>
              <strong>$<%= number_with_precision(@check.subtotal - @check.total_discounts, precision: 2) %></strong>
            </div>
          </div>
        </div>
      <% end %>

      <% if @global_fees.any? %>
        <% subtotal_after_discounts = @check.subtotal - @check.total_discounts %>

        <div class="card mb-3">
          <div class="card-header py-2">
            <strong class="small">Tax, tip, and other fees</strong>
          </div>

          <ul class="list-group list-group-flush">
            <% @global_fees.order(amount: :desc).each do |fee| %>
              <li class="list-group-item py-2 px-3">
                <div class="d-flex justify-content-between small">
                  <span class="text-muted">
                    <%= fee.description %>
                    <% if subtotal_after_discounts > 0 %>
                      <span class="text-muted">(<%= number_to_percentage((fee.amount / subtotal_after_discounts) * 100, precision: 1) %>)</span>
                    <% end %>
                  </span>
                  <span>+$<%= number_with_precision(fee.amount, precision: 2) %></span>
                </div>
              </li>
            <% end %>
          </ul>

          <div class="card-footer py-2 px-3">
            <div class="d-flex justify-content-between small">
              <strong>Grand total</strong>
              <strong>$<%= number_with_precision(@check.calculated_total, precision: 2) %></strong>
            </div>
            <% if @check.grand_total.present? && @check.grand_total != @check.calculated_total %>
              <div class="d-flex justify-content-between small text-muted">
                <span>Receipt showed</span>
                <span>$<%= number_with_precision(@check.grand_total, precision: 2) %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="d-grid mb-4">
        <%= f.submit "Save Selections", class: "btn btn-primary btn-lg" %>
      </div>
    <% end %>

    <div class="card">
      <div class="card-header py-2">
        <strong class="small">Who Owes What</strong>
      </div>
      <% @participants.each do |participant| %>
        <% participant_items = @line_items.select { |item| item.participant_ids.include?(participant.id) } %>
        <% items_subtotal = participant_items.sum { |item| item.amount_per_participant } %>
        <% proportion = @check.subtotal > 0 ? items_subtotal / @check.subtotal : 0 %>
        <div class="card-body py-2 px-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>
              <%= participant.name %>
              <% if participant_items.any? && @check.subtotal > 0 %>
                <span class="fw-normal text-muted small">(share: <%= number_to_percentage(proportion * 100, precision: 0) %>)</span>
              <% end %>
            </strong>
            <strong>$<%= number_with_precision(@check.amount_owed_by(participant), precision: 2) %></strong>
          </div>

          <% if participant_items.any? %>
            <% participant_items.each do |item| %>
              <% share = item.amount_per_participant %>
              <div class="d-flex justify-content-between small text-muted">
                <span>
                  <%= item.description %>
                  <% other_participants = item.participants.where.not(id: participant.id) %>
                  <% if other_participants.any? %>
                    <span class="text-muted">(shared with <%= other_participants.map(&:name).join(", ") %>)</span>
                  <% end %>
                </span>
                <span>$<%= number_with_precision(share, precision: 2) %></span>
              </div>
            <% end %>

            <% if @check.subtotal > 0 && @check.total_discounts > 0 %>
              <% discounts_share = @check.total_discounts * proportion %>
              <div class="d-flex justify-content-between small text-success">
                <span>Share of discounts</span>
                <span>-$<%= number_with_precision(discounts_share, precision: 2) %></span>
              </div>
            <% end %>

            <% if @check.subtotal > 0 && @check.total_fees > 0 %>
              <% fees_share = @check.total_fees * proportion %>
              <div class="d-flex justify-content-between small text-muted">
                <span>Share of tax, tip, and other fees</span>
                <span>$<%= number_with_precision(fees_share, precision: 2) %></span>
              </div>
            <% end %>
          <% else %>
            <div class="small text-muted fst-italic">No items assigned</div>
          <% end %>
        </div>
      <% end %>

      <% unassigned_items = @line_items.select { |item| item.participants_count == 0 } %>
      <% if unassigned_items.any? %>
        <% unassigned_subtotal = unassigned_items.sum { |item| item.total_with_addons } %>
        <% unassigned_proportion = @check.subtotal > 0 ? unassigned_subtotal / @check.subtotal : 0 %>
        <div class="card-body py-2 px-3 border-bottom bg-warning-subtle">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>
              Remaining
              <% if @check.subtotal > 0 %>
                <span class="fw-normal text-muted small">(share: <%= number_to_percentage(unassigned_proportion * 100, precision: 0) %>)</span>
              <% end %>
            </strong>
            <% unassigned_total = unassigned_subtotal + (@check.total_fees - @check.total_discounts) * unassigned_proportion %>
            <strong>$<%= number_with_precision(unassigned_total, precision: 2) %></strong>
          </div>

          <% unassigned_items.each do |item| %>
            <div class="d-flex justify-content-between small text-muted">
              <span><%= item.description %></span>
              <span>$<%= number_with_precision(item.total_with_addons, precision: 2) %></span>
            </div>
          <% end %>

          <% if @check.subtotal > 0 && @check.total_discounts > 0 %>
            <% discounts_share = @check.total_discounts * unassigned_proportion %>
            <div class="d-flex justify-content-between small text-success">
              <span>Share of discounts</span>
              <span>-$<%= number_with_precision(discounts_share, precision: 2) %></span>
            </div>
          <% end %>

          <% if @check.subtotal > 0 && @check.total_fees > 0 %>
            <% fees_share = @check.total_fees * unassigned_proportion %>
            <div class="d-flex justify-content-between small text-muted">
              <span>Share of tax, tip, and other fees</span>
              <span>$<%= number_with_precision(fees_share, precision: 2) %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
