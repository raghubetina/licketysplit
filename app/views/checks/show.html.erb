<div class="container-fluid py-4">
  <div class="row">
    <!-- Receipt Image and Restaurant Info -->
    <div class="col-lg-4 mb-4">
      <div class="card">
        <% if @check.receipt_image.attached? %>
          <%= image_tag @check.receipt_image, class: "card-img-top", style: "max-height: 500px; object-fit: contain;" %>
        <% else %>
          <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 300px;">
            <i class="bi bi-receipt fs-1 text-white"></i>
          </div>
        <% end %>

        <div class="card-body">
          <h2 class="card-title"><%= @check.restaurant_name %></h2>

          <% if @check.restaurant_address.present? %>
            <p class="text-muted mb-1">
              <i class="bi bi-geo-alt"></i> <%= @check.restaurant_address %>
            </p>
          <% end %>

          <% if @check.restaurant_phone_number.present? %>
            <p class="text-muted mb-1">
              <i class="bi bi-telephone"></i> <%= @check.restaurant_phone_number %>
            </p>
          <% end %>

          <% if @check.billed_on.present? %>
            <p class="text-muted mb-3">
              <i class="bi bi-calendar"></i> <%= @check.billed_on.strftime("%B %d, %Y at %l:%M %p") %>
            </p>
          <% end %>

          <div class="alert alert-info mb-3">
            <h5 class="alert-heading">Grand Total</h5>
            <p class="mb-0 fs-3 fw-bold"><%= format_currency(@check.grand_total, @check.currency) %></p>
          </div>

          <div class="mb-3">
            <span class="badge bg-<%= check_status_color(@check.status) %> fs-6">
              <%= @check.status.capitalize %>
            </span>
          </div>

          <div class="d-grid gap-2">
            <%= link_to "Edit Check", edit_check_path(@check), class: "btn btn-outline-primary" %>
            <%= button_to "Delete Check", @check, method: :delete, class: "btn btn-outline-danger",
                form: { data: { turbo_confirm: "Are you sure?" } } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Check Details -->
    <div class="col-lg-8">
      <!-- Line Items -->
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Line Items (<%= @line_items.count %>)</h4>
        </div>
        <div class="card-body">
          <% if @line_items.any? %>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th class="text-center">Qty</th>
                    <th class="text-end">Unit Price</th>
                    <th class="text-end">Total</th>
                    <th class="text-center">Participants</th>
                  </tr>
                </thead>
                <tbody>
                  <% @line_items.each do |item| %>
                    <tr>
                      <td>
                        <div>
                          <strong><%= item.description %></strong>
                          <% if item.has_warnings? %>
                            <span class="badge bg-warning text-dark ms-2" title="<%= item.full_warnings_messages.join('; ') %>">
                              <i class="bi bi-exclamation-triangle"></i> Warning
                            </span>
                          <% end %>
                          <% if item.discount.present? && item.discount > 0 %>
                            <br><small class="text-success">
                              Discount: -<%= format_currency(item.discount, @check.currency) %>
                              <% if item.discount_description.present? %>
                                (<%= item.discount_description %>)
                              <% end %>
                            </small>
                          <% end %>
                          <% if item.has_warnings? %>
                            <div class="alert alert-warning mt-2 mb-0 p-2 small">
                              <i class="bi bi-exclamation-triangle"></i> Data quality issues:
                              <ul class="mb-0">
                                <% item.full_warnings_messages.each do |warning| %>
                                  <li><%= warning %></li>
                                <% end %>
                              </ul>
                            </div>
                          <% end %>
                        </div>

                        <!-- Addons -->
                        <% if item.addons.any? %>
                          <div class="mt-2 ms-3">
                            <% item.addons.each do |addon| %>
                              <div class="small">
                                <i class="bi bi-plus-circle text-muted"></i>
                                <%= addon.description %>
                                <% if addon.quantity > 1 %>
                                  x<%= addon.quantity %>
                                <% elsif addon.quantity == 0 %>
                                  <span class="badge bg-warning text-dark ms-1">x0</span>
                                <% end %>
                                <span class="text-muted">
                                  +<%= format_currency(addon.total_price, @check.currency) %>
                                </span>
                                <% if addon.discount.present? && addon.discount > 0 %>
                                  <span class="text-success">
                                    (-<%= format_currency(addon.discount, @check.currency) %>)
                                  </span>
                                <% end %>
                                <% if addon.has_warnings? %>
                                  <span class="badge bg-warning text-dark ms-1" title="<%= addon.full_warnings_messages.join('; ') %>">
                                    <i class="bi bi-exclamation-triangle"></i>
                                  </span>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        <% end %>
                      </td>
                      <td class="text-center"><%= item.quantity %></td>
                      <td class="text-end"><%= format_currency(item.unit_price, @check.currency) %></td>
                      <td class="text-end">
                        <strong><%= format_currency(item.total_with_addons, @check.currency) %></strong>
                      </td>
                      <td class="text-center">
                        <% if item.participants.any? %>
                          <span class="badge bg-primary"><%= item.participants.count %></span>
                        <% else %>
                          <span class="badge bg-secondary">0</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3">Subtotal</th>
                    <th class="text-end">
                      <%= format_currency(@line_items.sum(&:total_with_addons), @check.currency) %>
                    </th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          <% else %>
            <p class="text-muted">No line items recorded.</p>
          <% end %>
        </div>
      </div>

      <!-- Global Fees and Global Discounts -->
      <div class="row">
        <!-- Global Fees -->
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Global Fees (<%= @global_fees.count %>)</h5>
            </div>
            <div class="card-body">
              <% if @global_fees.any? %>
                <ul class="list-group list-group-flush">
                  <% @global_fees.each do |fee| %>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <span><%= fee.description %></span>
                      <strong class="text-danger">+<%= format_currency(fee.amount, @check.currency) %></strong>
                    </li>
                  <% end %>
                </ul>
                <div class="mt-3 pt-3 border-top">
                  <div class="d-flex justify-content-between">
                    <strong>Total Fees:</strong>
                    <strong class="text-danger">+<%= format_currency(@global_fees.sum(:amount), @check.currency) %></strong>
                  </div>
                </div>
              <% else %>
                <p class="text-muted mb-0">No fees recorded.</p>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Global Discounts -->
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Global Discounts (<%= @global_discounts.count %>)</h5>
            </div>
            <div class="card-body">
              <% if @global_discounts.any? %>
                <ul class="list-group list-group-flush">
                  <% @global_discounts.each do |discount| %>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <span><%= discount.description %></span>
                      <strong class="text-success">-<%= format_currency(discount.amount, @check.currency) %></strong>
                    </li>
                  <% end %>
                </ul>
                <div class="mt-3 pt-3 border-top">
                  <div class="d-flex justify-content-between">
                    <strong>Total Discounts:</strong>
                    <strong class="text-success">-<%= format_currency(@global_discounts.sum(:amount), @check.currency) %></strong>
                  </div>
                </div>
              <% else %>
                <p class="text-muted mb-0">No discounts recorded.</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Participants -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Participants (<%= @participants.count %>)</h5>
          <%= link_to "Add Participant", new_check_participant_path(@check), class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @participants.any? %>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Items</th>
                    <th>Status</th>
                    <th class="text-end">Amount Owed</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @participants.each do |participant| %>
                    <tr>
                      <td><strong><%= participant.name %></strong></td>
                      <td>
                        <% if participant.line_items.any? %>
                          <span class="badge bg-primary"><%= participant.line_items.count %> items</span>
                        <% else %>
                          <span class="text-muted">No items assigned</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-<%= participant.payment_status == 'paid' ? 'success' : 'warning' %>">
                          <%= participant.payment_status.capitalize %>
                        </span>
                      </td>
                      <td class="text-end">
                        <strong><%= format_currency(@check.amount_owed_by(participant), @check.currency) %></strong>
                      </td>
                      <td class="text-end">
                        <%= button_to "Remove", check_participant_path(@check, participant),
                            method: :delete,
                            class: "btn btn-sm btn-outline-danger",
                            form: { data: { turbo_confirm: "Remove #{participant.name}?" } } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted mb-3">No participants added yet.</p>
            <%= link_to "Add First Participant", new_check_participant_path(@check), class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <%= link_to checks_path, class: "btn btn-outline-secondary" do %>
          <i class="bi bi-arrow-left"></i> Back to Checks
        <% end %>
        <%= link_to "Edit Check", edit_check_path(@check), class: "btn btn-primary" %>
      </div>
    </div>
  </div>
</div>
