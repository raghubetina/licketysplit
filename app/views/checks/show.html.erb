<%= turbo_stream_from @check %>

<div class="container py-3">
  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if @check.receipt_image.attached? %>
    <div class="mb-3">
      <%= image_tag @check.receipt_image, class: "img-fluid rounded" %>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h5 mb-3"><%= @check.restaurant_name || "Check" %></h1>
      <div class="text-muted small">
        <% if @check.billed_on.present? %>
          <%= @check.billed_on.strftime("%b %d, %Y") %>
        <% end %>
      </div>
    </div>
    <div class="text-end">
      <div class="h4 mb-0">$<%= number_with_precision(@check.grand_total, precision: 2) %></div>
      <div class="text-muted small"><%= @participants.count %> people</div>
    </div>
  </div>

  <% if @participants.empty? %>
    <div class="alert alert-warning">
      No participants yet. <%= link_to "Add participants", new_check_participant_path(@check) %> to start splitting.
    </div>
  <% elsif @line_items.empty? %>
    <div class="alert alert-warning">
      No items found on this receipt.
    </div>
  <% else %>
    <div class="card mb-3">
      <div class="card-header py-3">
        <strong class="small">Items</strong>
      </div>

      <ul id="line_items_list" class="list-group list-group-flush">
        <% @line_items.each do |item| %>
          <%= render partial: "line_items/line_item", locals: { line_item: item, participants: @participants } %>
        <% end %>
        <%= render partial: "line_items/new_form", locals: { line_item: LineItem.new, check: @check } %>
      </ul>

        <%= render partial: "checks/item_total", locals: { check: @check } %>
      </div>

      <div class="card mb-3">
        <div class="card-header py-3">
          <strong class="small">Discounts</strong>
        </div>

        <ul class="list-group list-group-flush">
          <% @global_discounts.each do |discount| %>
            <%= render partial: "global_discounts/global_discount", locals: { global_discount: discount, check: @check } %>
          <% end %>
          <%= render partial: "global_discounts/new_form", locals: { global_discount: GlobalDiscount.new, check: @check } %>
        </ul>

        <% if @global_discounts.any? %>
          <%= render partial: "checks/after_discounts_total", locals: { check: @check } %>
        <% end %>
      </div>

      <div class="card mb-3">
        <div class="card-header py-3">
          <strong class="small">Tax, tip, and other fees</strong>
        </div>

        <ul class="list-group list-group-flush">
          <% @global_fees.in_order_of(:fee_type, %w[tax other tip]).order(amount: :desc).each do |fee| %>
            <%= render partial: "global_fees/global_fee", locals: { global_fee: fee, check: @check } %>
          <% end %>

          <%= render partial: "global_fees/tip_suggestion", locals: { check: @check } %>

          <%= render partial: "global_fees/new_form", locals: { global_fee: GlobalFee.new, check: @check } %>
        </ul>

        <%= render partial: "checks/grand_total", locals: { check: @check } %>
      </div>

    <%= render partial: "checks/breakdown", locals: { check: @check, participants: @participants, line_items: @line_items } %>
  <% end %>
</div>

