<%= turbo_stream_from @check %>

<div class="container py-3">
  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if @check.receipt_image.attached? %>
    <div class="mb-3">
      <%= image_tag @check.receipt_image, class: "img-fluid rounded" %>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h5 mb-3"><%= @check.restaurant_name || "Check" %></h1>
      <div class="text-muted small">
        <% if @check.billed_on.present? %>
          <%= @check.billed_on.strftime("%b %d, %Y") %>
        <% end %>
      </div>
    </div>
    <div class="text-end">
      <div class="h4 mb-0">$<%= number_with_precision(@check.grand_total, precision: 2) %></div>
      <div class="text-muted small"><%= @participants.count %> people</div>
    </div>
  </div>

  <% if @participants.empty? %>
    <div class="alert alert-warning">
      No participants yet. <%= link_to "Add participants", new_check_participant_path(@check) %> to start splitting.
    </div>
  <% elsif @line_items.empty? %>
    <div class="alert alert-warning">
      No items found on this receipt.
    </div>
  <% else %>
    <div class="card mb-3">
      <div class="card-header py-3">
        <strong class="small">Items</strong>
      </div>

      <ul id="line_items_list" class="list-group list-group-flush">
        <% @line_items.each do |item| %>
          <%= render partial: "line_items/line_item", locals: { line_item: item, participants: @participants } %>
        <% end %>
        <%= render partial: "line_items/new_form", locals: { line_item: LineItem.new, check: @check } %>
      </ul>

        <div class="card-footer py-3 px-3">
          <div class="d-flex justify-content-between small">
            <strong>Item total</strong>
            <strong>$<%= number_with_precision(@check.subtotal, precision: 2) %></strong>
          </div>
        </div>
      </div>

      <% if @global_discounts.any? %>
        <div class="card mb-3">
          <div class="card-header py-3">
            <strong class="small">Discounts</strong>
          </div>

          <ul class="list-group list-group-flush">
            <% @global_discounts.each do |discount| %>
              <li id="<%= dom_id(discount) %>" class="list-group-item py-3 px-3">
                <div class="d-flex justify-content-between align-items-center small text-success">
                  <div class="d-flex align-items-center">
                    <%= button_to check_global_discount_path(@check, discount), method: :delete, class: "btn btn-link p-0 text-success me-2", title: "Delete discount", form: { data: { turbo_confirm: "Delete this discount?" } } do %>
                      <i class="bi bi-trash small"></i>
                    <% end %>
                    <span><%= discount.description %></span>
                  </div>
                  <span>-$<%= number_with_precision(discount.amount, precision: 2) %></span>
                </div>
              </li>
            <% end %>
          </ul>

          <div class="card-footer py-3 px-3">
            <div class="d-flex justify-content-between small">
              <strong>After discounts</strong>
              <strong>$<%= number_with_precision(@check.subtotal - @check.total_discounts, precision: 2) %></strong>
            </div>
          </div>
        </div>
      <% end %>

      <% if @global_fees.any? %>
        <% subtotal_after_discounts = @check.subtotal - @check.total_discounts %>

        <div class="card mb-3">
          <div class="card-header py-3">
            <strong class="small">Tax, tip, and other fees</strong>
          </div>

          <ul class="list-group list-group-flush">
            <% @global_fees.order(amount: :desc).each do |fee| %>
              <li id="<%= dom_id(fee) %>" class="list-group-item py-3 px-3">
                <div class="d-flex justify-content-between align-items-center small">
                  <div class="d-flex align-items-center text-muted">
                    <%= button_to check_global_fee_path(@check, fee), method: :delete, class: "btn btn-link p-0 text-muted me-2", title: "Delete fee", form: { data: { turbo_confirm: "Delete this fee?" } } do %>
                      <i class="bi bi-trash small"></i>
                    <% end %>
                    <span>
                      <%= fee.description %>
                      <% if subtotal_after_discounts > 0 %>
                        (<%= number_to_percentage((fee.amount / subtotal_after_discounts) * 100, precision: 1) %>)
                      <% end %>
                    </span>
                  </div>
                  <span>+$<%= number_with_precision(fee.amount, precision: 2) %></span>
                </div>
              </li>
            <% end %>
          </ul>

          <div class="card-footer py-3 px-3">
            <div class="d-flex justify-content-between small">
              <strong>Grand total</strong>
              <strong>$<%= number_with_precision(@check.calculated_total, precision: 2) %></strong>
            </div>
            <% if @check.grand_total.present? && @check.grand_total != @check.calculated_total %>
              <div class="d-flex justify-content-between small text-muted">
                <span>Receipt showed</span>
                <span>$<%= number_with_precision(@check.grand_total, precision: 2) %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

    <%= render partial: "checks/breakdown", locals: { check: @check, participants: @participants, line_items: @line_items } %>
  <% end %>
</div>
