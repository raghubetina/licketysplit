<%# Accepts: check (required), line_items (optional), show_zero_items (optional, defaults to true) %>
<% line_items ||= check.line_items.includes(:participants, :addons).order(:position, :created_at) %>
<% show_zero_items = true unless local_assigns.key?(:show_zero_items) %>

<% unassigned_items = line_items.select { |item| item.participants_count == 0 } %>
<% unassigned_items = unassigned_items.reject { |item| item.total_with_addons == 0 } unless show_zero_items %>
<% if unassigned_items.any? %>
  <% unassigned_subtotal = unassigned_items.sum { |item| item.total_with_addons } %>
  <% unassigned_proportion = check.subtotal > 0 ? unassigned_subtotal / check.subtotal : 0 %>
  <div id="remaining_breakdown" class="card-footer py-3 px-3 d-flex flex-column gap-3">
    <div class="d-flex justify-content-between align-items-center">
      <strong>
        Remaining
        <% if check.subtotal > 0 %>
          <span class="fw-normal text-muted">(share: <%= number_to_percentage(unassigned_proportion * 100, precision: 0) %>)</span>
        <% end %>
      </strong>
      <% unassigned_total = unassigned_subtotal + (check.total_fees - check.total_discounts) * unassigned_proportion %>
      <strong><%= format_currency(unassigned_total, check.currency_symbol) %></strong>
    </div>

    <% unassigned_items.each do |item| %>
      <div class="d-flex justify-content-between text-muted">
        <span><%= item.description %></span>
        <span><%= format_currency(item.total_with_addons, check.currency_symbol) %></span>
      </div>
    <% end %>

    <% if check.subtotal > 0 && check.total_discounts > 0 %>
      <% discounts_share = check.total_discounts * unassigned_proportion %>
      <div class="d-flex justify-content-between text-success">
        <span>Share of discounts</span>
        <span>-<%= format_currency(discounts_share, check.currency_symbol) %></span>
      </div>
    <% end %>

    <% if check.subtotal > 0 && check.total_fees > 0 %>
      <% fees_share = check.total_fees * unassigned_proportion %>
      <div class="d-flex justify-content-between text-muted">
        <span>Share of tax, tip, and other fees</span>
        <span><%= format_currency(fees_share, check.currency_symbol) %></span>
      </div>
    <% end %>
  </div>
<% else %>
  <div id="remaining_breakdown" class="card-footer py-3 px-3 d-flex flex-column gap-3">
    <div class="d-flex justify-content-between align-items-center">
      <strong>Remaining</strong>
      <strong><%= format_currency(0, check.currency_symbol) %></strong>
    </div>
    <div class="text-muted fst-italic">All items assigned</div>
  </div>
<% end %>
