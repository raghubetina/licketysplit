<%# Accepts: line_item (required), check (optional - will be derived from line_item if not provided), participants (optional - will be queried if not provided) %>
<% check ||= line_item.check %>
<% participants ||= check.participants.order(:name) %>

<li id="<%= dom_id(line_item) %>" class="list-group-item py-2 px-3">
  <%= turbo_frame_tag dom_id(line_item, :content) do %>
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div class="d-flex align-items-baseline">
        <%= link_to edit_check_line_item_path(check, line_item), class: "text-muted me-2", title: "Edit item" do %>
          <i class="bi bi-pencil small"></i>
        <% end %>
        <span class="text-muted small me-2 text-end" style="min-width: 50px;">$<%= number_with_precision(line_item.total_price, precision: 2) %></span>
        <span>
          <strong class="small"><%= line_item.description %></strong>
          <% if line_item.quantity > 1 %>
            <span class="text-muted small">(<%= line_item.quantity %>x @ $<%= number_with_precision(line_item.unit_price, precision: 2) %> each)</span>
          <% end %>
        </span>
      </div>
      <strong class="small">$<%= number_with_precision(line_item.total_with_addons, precision: 2) %></strong>
    </div>
    <% if line_item.discount && line_item.discount > 0 %>
      <div class="d-flex align-items-baseline mb-1">
        <span class="me-2" style="width: 1em;"></span>
        <span class="text-success small me-2 text-end" style="min-width: 50px;">-$<%= number_with_precision(line_item.discount, precision: 2) %></span>
        <span class="text-success small">
          <% if line_item.discount_description.present? %>
            <%= line_item.discount_description %>
          <% else %>
            Discount
          <% end %>
        </span>
      </div>
    <% end %>
  <% end %>

  <% line_item.addons.each do |addon| %>
    <%= render partial: "addons/addon", locals: { addon: addon, line_item: line_item } %>
  <% end %>

  <div class="d-flex flex-wrap gap-2" data-controller="checkbox-toggle" data-checkbox-toggle-url-value="<%= toggle_participant_line_item_path(line_item) %>">
    <% participants.each do |participant| %>
      <div class="form-check form-check-inline m-0 participant-checkbox">
        <%= check_box_tag "participant_#{participant.id}",
            participant.id,
            line_item.participant_ids.include?(participant.id),
            id: "item_#{line_item.id}_participant_#{participant.id}",
            class: "form-check-input",
            data: { action: "change->checkbox-toggle#toggle" } %>
        <%= label_tag "item_#{line_item.id}_participant_#{participant.id}",
            participant.name,
            class: "form-check-label small" %>
      </div>
    <% end %>
  </div>
</li>
